---
'3':
- role:
  - primary-controller
  parameters:
    retries: 3
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/astute/ironic_post_swift_key.rb
    timeout: 180
    interval: 20
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: enable_quorum
  - node_id: '3'
    name: enable_rados
  id: ironic_post_swift_key
  condition: settings:additional_components.ironic.value == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-mysqld.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-mysqld_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-mysqld
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-cinder/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-cinder
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: cinder-db
- groups:
  - primary-controller
  - controller
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/agents/l3.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-networks
  - node_id: '3'
    name: openstack-network-routers
  - node_id: '3'
    name: openstack-network-plugins-l2
  refresh_on:
  - neutron_l3_agent_config
  id: openstack-network-agents-l3
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: tools
  id: netconfig
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/astute/dump_rabbitmq_definitions.pp"
    timeout: 180
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: dump_rabbitmq_definitions
- role: "*"
  parameters:
    src: rsync://{MASTER_IP}:/puppet/{OPENSTACK_VERSION}/modules/
    dst: "/etc/puppet/modules"
    timeout: 180
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: sync
  requires:
  - node_id: '3'
    name: upload_core_repos
  id: rsync_core_puppet
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceilometer/controller.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceilometer/controller_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceilometer/controller_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: openstack-controller
  - node_id: '3'
    name: swift
  requires:
  - node_id: '3'
    name: mongo
  - node_id: '3'
    name: primary-mongo
  - node_id: '3'
    name: openstack-haproxy
  id: ceilometer-controller
  condition: settings:additional_components.ceilometer.value == true
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/override_configuration.pp"
    timeout: 180
    cwd: "/"
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: pre_hiera_config
  id: override_configuration
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceilometer/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: ceilometer-controller
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: ceilometer-keystone
  condition: settings:additional_components.ceilometer.value == true
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-controller/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-controller
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: nova-db
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/keystone/workloads_collector_add.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: workloads_collector_add
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/hiera.pp"
    timeout: 3600
  test_post:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/hiera/hiera_post.py
  type: puppet
  test_pre:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/hiera/hiera_pre.py
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  id: hiera
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/virtual_ips/virtual_ips.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/virtual_ips/virtual_ips_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: cluster
  id: virtual_ips
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-murano.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-murano_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-murano
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-radosgw.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-radosgw_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-radosgw
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-swift.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-swift_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-swift
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/heat/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: heat
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: heat-db
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-neutron.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-neutron_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-neutron
- role:
  - primary-controller
  - controller
  - ceph-osd
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/updatedb.pp"
    timeout: 60
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: updatedb
  condition: settings:storage.objects_ceph.value == true or settings:storage.images_ceph.value
    == true or settings:storage.volumes_ceph.value == true or settings:storage.ephemeral_ceph.value
    == true
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ironic/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: ironic-api
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: ironic-db
  condition: settings:additional_components.ironic.value == true
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-controller/openstack-controller.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  refresh_on:
  - nova_config
  - nova_paste_api_ini
  id: openstack-controller
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceilometer/radosgw_user.pp"
    timeout: 300
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  - node_id: '3'
    name: enable_rados
  id: ceilometer-radosgw-user
  condition: settings:additional_components.ceilometer.value == true and settings:storage.objects_ceph.value
    == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-keystone.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-keystone_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-keystone
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hosts/hosts.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/hosts/hosts_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/hosts/hosts_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: netconfig
  id: hosts
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/routers.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-networks
  id: openstack-network-routers
  condition: settings:neutron_advanced_configuration.neutron_l3_ha.value == false
- requires:
  - node_id: '3'
    name: deploy_end
  type: stage
  id: post_deployment_start
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/roles/controller.pp"
    timeout: 3600
  type: puppet
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires: []
  id: controller_remaining_tasks
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/glance/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: glance
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: glance-keystone
- requires:
  - node_id: '3'
    name: post_deployment_start
  type: stage
  id: post_deployment_end
  required_for: []
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/vmware/vcenter.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: controller_remaining_tasks
  id: vmware-vcenter
  condition: settings:common.use_vcenter.value == true
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/rabbitmq/rabbitmq.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: openstack-controller
  - node_id: '3'
    name: glance
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/rabbitmq/rabbitmq_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  id: rabbitmq
- role:
  - primary-controller
  parameters:
    strategy:
      type: one_by_one
  required_for:
  - node_id: '3'
    name: deploy_end
  type: group
  requires:
  - node_id: '3'
    name: deploy_start
  id: primary-controller
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/dns/dns-server.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  id: dns-server
- role:
  - primary-controller
  - compute-vmware
  parameters:
    cmd: "/usr/bin/python /etc/puppet/modules/osnailyfacter/modular/astute/vcenter_hooks.py
      --create_zones"
    timeout: 180
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: vcenter_compute_zones_create
  condition: settings:common.use_vcenter.value == true
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules/"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-cinder/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-cinder
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: cinder-keystone
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/neutron/neutron.pub"
      dst: "/var/lib/astute/neutron/neutron.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/neutron/neutron"
      dst: "/var/lib/astute/neutron/neutron"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/nova/nova.pub"
      dst: "/var/lib/astute/nova/nova.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/nova/nova"
      dst: "/var/lib/astute/nova/nova"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mysql/mysql.pub"
      dst: "/var/lib/astute/mysql/mysql.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mysql/mysql"
      dst: "/var/lib/astute/mysql/mysql"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mongodb/mongodb.key"
      dst: "/var/lib/astute/mongodb/mongodb.key"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/fernet-keys/0"
      dst: "/var/lib/astute/keystone/0"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/fernet-keys/1"
      dst: "/var/lib/astute/keystone/1"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '3'
    name: generate_keys
  id: copy_keys
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/enable_rados.pp"
    timeout: 180
    cwd: "/"
  required_for:
  - node_id: '3'
    name: upload_cirros
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: enable_rados
  condition: settings:storage.objects_ceph.value == true
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ntp/ntp-check.pp"
    timeout: 600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: ntp-server
  type: puppet
  requires:
  - node_id: '3'
    name: dns-client
  id: ntp-check
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/keystone/keystone.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/keystone/keystone_post.rb
  type: puppet
  refresh_on:
  - keystone_config
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/keystone/keystone_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: openstack-controller
  requires:
  - node_id: '3'
    name: openstack-haproxy
  - node_id: '3'
    name: database
  - node_id: '3'
    name: rabbitmq
  id: keystone
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/astute/service_token_off.pp"
    timeout: 180
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: upload_cirros
  id: disable_keystone_service_token
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/umm/umm.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: tools
  id: umm
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/mon.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-controller
  id: ceph-mon
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/memcached/memcached.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: keystone
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/memcached/memcached_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  id: memcached
- requires:
  - node_id: '3'
    name: pre_deployment_start
  type: stage
  id: pre_deployment_end
  required_for: []
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/sahara/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: sahara
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: sahara-keystone
  condition: settings:additional_components.sahara.value == true
- requires:
  - node_id: '3'
    name: pre_deployment_end
  type: stage
  id: deploy_start
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/radosgw.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceph/radosgw_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceph/radosgw_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  requires:
  - node_id: '3'
    name: apache
  - node_id: '3'
    name: ceph-mon
  id: ceph-radosgw
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-sahara.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-sahara_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-sahara
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving.pp"
    timeout: 3600
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving_pre.rb
  groups:
  - primary-controller
  - controller
  - compute
  - compute-vmware
  - cinder
  - cinder-vmware
  - primary-mongo
  - mongo
  - ceph-osd
  - virt
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: firewall
  id: ssl-keys-saving
  condition: "(settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true) and settings:public_ssl.cert_source.value == 'user_uploaded'"
- role:
  - primary-controller
  parameters:
    retries: 3
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/astute/upload_cirros.rb
    timeout: 180
    interval: 20
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: enable_quorum
  id: upload_cirros
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/apache/apache.pp"
    timeout: 1200
  required_for:
  - node_id: '3'
    name: keystone
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/apache/apache_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  id: apache
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/swift/swift.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/swift/swift_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/swift/swift_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  requires:
  - node_id: '3'
    name: openstack-controller
  id: swift
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: neutron-keystone
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/logging/logging.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: globals
  id: logging
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-controller/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-controller
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: nova-keystone
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hosts/hosts.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: upload_nodes_info
  id: update_hosts
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ironic/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: ironic-api
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: ironic-keystone
  condition: settings:additional_components.ironic.value == true
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/netconfig/connectivity_tests.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: firewall
  - node_id: '3'
    name: hosts
  type: puppet
  requires:
  - node_id: '3'
    name: netconfig
  id: connectivity_tests
- groups:
  - primary-controller
  - controller
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/agents/metadata.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-common-config
  - node_id: '3'
    name: openstack-network-server-nova
  - node_id: '3'
    name: openstack-network-agents-l3
  refresh_on:
  - neutron_metadata_agent_config
  id: openstack-network-agents-metadata
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/virtual_ips/conntrackd.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/virtual_ips/conntrackd_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/virtual_ips/conntrackd_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: virtual_ips
  id: conntrackd
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/sahara/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: sahara
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: sahara-db
  condition: settings:additional_components.sahara.value == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/horizon/horizon.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/horizon/horizon_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/horizon/horizon_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: openstack-controller
  id: horizon
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/hiera.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: pre_deployment_start
  - node_id: '3'
    name: rsync_core_puppet
  id: pre_hiera_config
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-ceilometer.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-ceilometer_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-ceilometer
- groups:
  - primary-controller
  - controller
  - compute
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/common-config.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-start
  id: openstack-network-common-config
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/firewall/firewall.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/firewall/firewall_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/firewall/firewall_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: netconfig
  id: firewall
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/cluster-haproxy/cluster-haproxy.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/cluster-haproxy/cluster-haproxy_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: virtual_ips
  - node_id: '3'
    name: cluster
  id: cluster-haproxy
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/globals/globals.pp"
    timeout: 3600
  test_post:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/globals/globals_post.py
  type: puppet
  test_pre:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/globals/globals_pre.py
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: hiera
  id: globals
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/glance/glance.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/glance/glance_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/glance/glance_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: openstack-controller
  requires:
  - node_id: '3'
    name: openstack-haproxy
  - node_id: '3'
    name: database
  id: glance
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/tools/tools.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/tools/tools_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: logging
  id: tools
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy.pp"
    timeout: 300
  required_for:
  - node_id: '3'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: openstack-haproxy-ceilometer
  - node_id: '3'
    name: openstack-haproxy-cinder
  - node_id: '3'
    name: openstack-haproxy-glance
  - node_id: '3'
    name: openstack-haproxy-heat
  - node_id: '3'
    name: openstack-haproxy-horizon
  - node_id: '3'
    name: openstack-haproxy-keystone
  - node_id: '3'
    name: openstack-haproxy-murano
  - node_id: '3'
    name: openstack-haproxy-mysqld
  - node_id: '3'
    name: openstack-haproxy-neutron
  - node_id: '3'
    name: openstack-haproxy-nova
  - node_id: '3'
    name: openstack-haproxy-radosgw
  - node_id: '3'
    name: openstack-haproxy-sahara
  - node_id: '3'
    name: openstack-haproxy-swift
  - node_id: '3'
    name: openstack-haproxy-stats
  - node_id: '3'
    name: openstack-haproxy-ironic
  id: openstack-haproxy
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
- role: "*"
  parameters:
    timeout: 180
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: upload_file
  requires:
  - node_id: '3'
    name: override_configuration
  id: upload_configuration
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/ceph_pools.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: ceph_ready_check
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: ceph_create_pools
  condition: settings:storage.objects_ceph.value == true or settings:storage.images_ceph.value
    == true or settings:storage.volumes_ceph.value == true or settings:storage.ephemeral_ceph.value
    == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-ironic.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-ironic_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-ironic
  condition: settings:additional_components.ironic.value == true
- role:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/routers.pp"
    timeout: 1800
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: openstack-network-routers-ha
  condition: settings:neutron_advanced_configuration.neutron_l3_ha.value == true
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/glance/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: glance
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: glance-db
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: neutron-db
- role:
  - primary-controller
  parameters:
    retries: 3
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ironic/upload_images.rb {CLUSTER_ID}
    timeout: 180
    interval: 20
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: enable_quorum
  - node_id: '3'
    name: enable_rados
  id: ironic_upload_images
  condition: settings:additional_components.ironic.value == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/swift/rebalance_cronjob.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/swift/rebalance_cronjob_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/swift/swift_post.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: swift
  id: swift-rebalance-cron
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/heat/heat.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/heat/heat_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/heat/heat_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: openstack-controller
  id: heat
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-stats.pp"
    timeout: 300
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-stats_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-stats
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ironic/ironic.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: openstack-controller
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-haproxy
  - node_id: '3'
    name: ironic-db
  - node_id: '3'
    name: ironic-keystone
  id: ironic-api
  condition: settings:additional_components.ironic.value == true
- role:
  - primary-mongo
  - mongo
  - primary-controller
  - controller
  - compute
  - ceph-osd
  - cinder
  - cinder-vmware
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/dns/dns-client.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: ntp-client
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: dns-client
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/cluster-vrouter/cluster-vrouter.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: virtual_ips
  type: puppet
  requires:
  - node_id: '3'
    name: cluster
  id: cluster-vrouter
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/murano/rabbitmq.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: murano
  type: puppet
  requires:
  - node_id: '3'
    name: rabbitmq
  id: murano-rabbitmq
  condition: settings:additional_components.murano.value == true
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/api-proxy/api-proxy.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/api-proxy/api-proxy_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: apache
  id: api-proxy
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/cluster/health.pp"
    timeout: 600
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/cluster/health_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: cluster
  id: cluster_health
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/heat/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: heat
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: heat-keystone
- requires: []
  type: stage
  id: pre_deployment_start
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-horizon.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-horizon_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-horizon
- role: "*"
  parameters:
    retries: 1
    cmd: rm -f /etc/hiera/nodes.yaml
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: pre_deployment_start
  id: clear_nodes_info
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/murano/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: murano
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: murano-db
  condition: settings:additional_components.murano.value == true
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/ceph/ceph.pub"
      dst: "/var/lib/astute/ceph/ceph.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/ceph/ceph"
      dst: "/var/lib/astute/ceph/ceph"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '3'
    name: generate_keys_ceph
  id: copy_keys_ceph
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/cluster/cluster.pp"
    timeout: 3600
  required_for:
  - node_id: '3'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/cluster/cluster_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: hosts
  - node_id: '3'
    name: firewall
  - node_id: '3'
    name: deploy_start
  id: cluster
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/sahara/sahara.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/sahara/sahara_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/sahara/sahara_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  requires:
  - node_id: '3'
    name: openstack-network-end
  - node_id: '3'
    name: horizon
  id: sahara
  condition: settings:additional_components.sahara.value == true
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/fuel_pkgs/fuel_pkgs.pp"
    timeout: 600
  required_for:
  - node_id: '3'
    name: hiera
  type: puppet
  requires:
  - node_id: '3'
    name: deploy_start
  id: fuel_pkgs
- role: "*"
  required_for: []
  type: upload_file
  id: upload_core_repos
  requires:
  - node_id: '3'
    name: pre_deployment_start
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/swift/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: swift
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: swift-keystone
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/virtual_ips/public_vip_ping.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: public_vip_ping
- parameters:
    path: "/etc/hiera/nodes.yaml"
  requires:
  - node_id: '3'
    name: post_deployment_start
  role: "*"
  required_for: []
  type: upload_file
  id: upload_nodes_info
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-glance.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-glance_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-glance
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/murano/murano.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/murano/murano_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/murano/murano_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: controller_remaining_tasks
  requires:
  - node_id: '3'
    name: heat
  - node_id: '3'
    name: horizon
  - node_id: '3'
    name: rabbitmq
  id: murano
  condition: settings:additional_components.murano.value == true
- role:
  - primary-controller
  parameters:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceph/ceph_ready_check.rb
    timeout: 1800
  required_for:
  - node_id: '3'
    name: enable_rados
  - node_id: '3'
    name: upload_cirros
  type: shell
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: ceph_ready_check
  condition: settings:storage.objects_ceph.value == true or settings:storage.images_ceph.value
    == true or settings:storage.volumes_ceph.value == true or settings:storage.ephemeral_ceph.value
    == true
- groups:
  - primary-controller
  - controller
  - compute
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/plugins/ml2.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-common-config
  - node_id: '3'
    name: openstack-network-server-config
  refresh_on:
  - neutron_plugin_ml2
  - neutron_agent_ovs
  - neutron_config
  - neutron_api_config
  id: openstack-network-plugins-l2
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/agents/dhcp.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-common-config
  - node_id: '3'
    name: openstack-network-server-nova
  - node_id: '3'
    name: openstack-network-agents-l3
  refresh_on:
  - neutron_dhcp_agent_config
  id: openstack-network-agents-dhcp
- role:
  - primary-controller
  parameters:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/astute/enable_quorum.rb
    timeout: 180
  required_for:
  - node_id: '3'
    name: post_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: post_deployment_start
  id: enable_quorum
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-nova.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-nova_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-nova
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/server-config.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-common-config
  refresh_on:
  - neutron_config
  - neutron_api_config
  id: openstack-network-server-config
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-cinder.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-cinder_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-cinder
- role:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ntp/ntp-server.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '3'
    name: ntp-client
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ntp/ntp_post.rb
  type: puppet
  requires:
  - node_id: '3'
    name: dns-client
  id: ntp-server
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/murano/keystone.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: murano
  type: puppet
  requires:
  - node_id: '3'
    name: keystone
  id: murano-keystone
  condition: settings:additional_components.murano.value == true
- requires:
  - node_id: '3'
    name: deploy_start
  type: stage
  id: deploy_end
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-heat.pp"
    timeout: 300
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy-heat_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/openstack-haproxy/openstack-haproxy_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: deploy_end
  requires:
  - node_id: '3'
    name: cluster-haproxy
  id: openstack-haproxy-heat
- groups:
  - primary-controller
  - controller
  - cinder-vmware
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-cinder/openstack-cinder.pp"
    timeout: 1200
  required_for:
  - node_id: '3'
    name: deploy_end
  - node_id: '3'
    name: openstack-controller
  type: puppet
  requires:
  - node_id: '3'
    name: rabbitmq
  - node_id: '3'
    name: keystone
  - node_id: '3'
    name: hosts
  - node_id: '3'
    name: firewall
  id: openstack-cinder
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/keystone/db.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: keystone
  type: puppet
  requires:
  - node_id: '3'
    name: database
  id: keystone-db
- role: "*"
  parameters:
    retries: 10
    cmd: ntpdate -u $(awk '/^server/ { if ($2 !~ /127\.127\.[0-9]+\.[0-9]+/) {ORS="
      "; print $2}}' /etc/ntp.conf)
    timeout: 180
    interval: 30
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: shell
  requires:
  - node_id: '3'
    name: pre_deployment_start
  id: sync_time
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/database/database.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/database/database_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/database/database_pre.rb
  groups:
  - primary-controller
  - controller
  required_for:
  - node_id: '3'
    name: openstack-controller
  requires:
  - node_id: '3'
    name: deploy_start
  - node_id: '3'
    name: openstack-haproxy
  id: database
- groups:
  - primary-controller
  - controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/server-nova.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-agents-l3
  id: openstack-network-server-nova
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/haproxy/public_haproxy.pem"
      dst: "/var/lib/astute/haproxy/public_haproxy.pem"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/haproxy/public_haproxy.crt"
      dst: "/etc/pki/tls/certs/public_haproxy.pem"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '3'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '3'
    name: generate_haproxy_keys
  id: copy_haproxy_keys
  condition: "(settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true) and settings:public_ssl.cert_source.value == 'self_signed'"
- groups:
  - primary-controller
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/networks.pp"
    timeout: 1800
  required_for:
  - node_id: '3'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '3'
    name: openstack-network-plugins-l2
  id: openstack-network-networks
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ssl/ssl_add_trust_chain.pp"
    timeout: 3600
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving_pre.rb
  groups:
  - primary-controller
  - controller
  - compute
  - compute-vmware
  - cinder
  - cinder-vmware
  - primary-mongo
  - mongo
  - ceph-osd
  - virt
  required_for:
  - node_id: '3'
    name: hosts
  requires:
  - node_id: '3'
    name: firewall
  - node_id: '3'
    name: ssl-keys-saving
  id: ssl-add-trust-chain
  condition: settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true
master:
- role: master
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/astute/generate_keys.sh -i {CLUSTER_ID}
      -s 'ceph' -p /var/lib/fuel/keys/
    timeout: 180
  required_for:
  - node_id: master
    name: copy_keys_ceph
  type: shell
  requires:
  - node_id: master
    name: pre_deployment_start
  id: generate_keys_ceph
- role: master
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/astute/generate_haproxy_keys.sh
      -i {CLUSTER_ID} -h {CN_HOSTNAME} -o 'haproxy' -p /var/lib/fuel/keys/
    timeout: 180
  required_for:
  - node_id: master
    name: copy_haproxy_keys
  type: shell
  requires:
  - node_id: master
    name: pre_deployment_start
  id: generate_haproxy_keys
  condition: "(settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true) and settings:public_ssl.cert_source.value == 'self_signed'"
- role: master
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/astute/generate_keys.sh -p /var/lib/fuel/keys/
      -i {CLUSTER_ID} -o 'mongodb' -s 'neutron nova mysql' -f '0 1'
    timeout: 180
  required_for:
  - node_id: master
    name: copy_keys
  type: shell
  requires:
  - node_id: master
    name: pre_deployment_start
  id: generate_keys
'4':
- groups:
  - primary-controller
  - controller
  - compute
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/common-config.pp"
    timeout: 1800
  required_for:
  - node_id: '4'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '4'
    name: openstack-network-start
  id: openstack-network-common-config
- role: "*"
  parameters:
    retries: 1
    cmd: rm -f /etc/hiera/nodes.yaml
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: shell
  requires:
  - node_id: '4'
    name: pre_deployment_start
  id: clear_nodes_info
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/ceph/ceph.pub"
      dst: "/var/lib/astute/ceph/ceph.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/ceph/ceph"
      dst: "/var/lib/astute/ceph/ceph"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '4'
    name: generate_keys_ceph
  id: copy_keys_ceph
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/globals/globals.pp"
    timeout: 3600
  test_post:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/globals/globals_post.py
  type: puppet
  test_pre:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/globals/globals_pre.py
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: hiera
  id: globals
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/fuel_pkgs/fuel_pkgs.pp"
    timeout: 600
  required_for:
  - node_id: '4'
    name: hiera
  type: puppet
  requires:
  - node_id: '4'
    name: deploy_start
  id: fuel_pkgs
- role: "*"
  required_for: []
  type: upload_file
  id: upload_core_repos
  requires:
  - node_id: '4'
    name: pre_deployment_start
- groups:
  - primary-controller
  - controller
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/agents/l3.pp"
    timeout: 1800
  required_for:
  - node_id: '4'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '4'
    name: openstack-network-networks
  - node_id: '4'
    name: openstack-network-routers
  - node_id: '4'
    name: openstack-network-plugins-l2
  refresh_on:
  - neutron_l3_agent_config
  id: openstack-network-agents-l3
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/netconfig/netconfig_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: tools
  id: netconfig
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/tools/tools.pp"
    timeout: 3600
  required_for:
  - node_id: '4'
    name: deploy_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/tools/tools_post.rb
  type: puppet
  requires:
  - node_id: '4'
    name: logging
  id: tools
- role: "*"
  parameters:
    src: rsync://{MASTER_IP}:/puppet/{OPENSTACK_VERSION}/modules/
    dst: "/etc/puppet/modules"
    timeout: 180
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: sync
  requires:
  - node_id: '4'
    name: upload_core_repos
  id: rsync_core_puppet
- role:
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/astute/enable_compute.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '4'
    name: post_deployment_start
  refresh_on:
  - nova_config
  - nova_paste_api_ini
  id: enable_nova_compute_service
- parameters:
    path: "/etc/hiera/nodes.yaml"
  requires:
  - node_id: '4'
    name: post_deployment_start
  role: "*"
  required_for: []
  type: upload_file
  id: upload_nodes_info
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/neutron/neutron.pub"
      dst: "/var/lib/astute/neutron/neutron.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/neutron/neutron"
      dst: "/var/lib/astute/neutron/neutron"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/nova/nova.pub"
      dst: "/var/lib/astute/nova/nova.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/nova/nova"
      dst: "/var/lib/astute/nova/nova"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mysql/mysql.pub"
      dst: "/var/lib/astute/mysql/mysql.pub"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mysql/mysql"
      dst: "/var/lib/astute/mysql/mysql"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/mongodb/mongodb.key"
      dst: "/var/lib/astute/mongodb/mongodb.key"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/fernet-keys/0"
      dst: "/var/lib/astute/keystone/0"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/fernet-keys/1"
      dst: "/var/lib/astute/keystone/1"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '4'
    name: generate_keys
  id: copy_keys
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/override_configuration.pp"
    timeout: 180
    cwd: "/"
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: puppet
  requires:
  - node_id: '4'
    name: pre_hiera_config
  id: override_configuration
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/firewall/firewall.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/firewall/firewall_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/firewall/firewall_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: netconfig
  id: firewall
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/hiera.pp"
    timeout: 3600
  test_post:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/hiera/hiera_post.py
  type: puppet
  test_pre:
    cmd: python /etc/puppet/modules/osnailyfacter/modular/hiera/hiera_pre.py
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: deploy_start
  id: hiera
- groups:
  - primary-controller
  - controller
  - compute
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/plugins/ml2.pp"
    timeout: 1800
  required_for:
  - node_id: '4'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '4'
    name: openstack-network-common-config
  - node_id: '4'
    name: openstack-network-server-config
  refresh_on:
  - neutron_plugin_ml2
  - neutron_agent_ovs
  - neutron_config
  - neutron_api_config
  id: openstack-network-plugins-l2
- requires:
  - node_id: '4'
    name: deploy_end
  type: stage
  id: post_deployment_start
  required_for: []
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/netconfig/connectivity_tests.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: firewall
  - node_id: '4'
    name: hosts
  type: puppet
  requires:
  - node_id: '4'
    name: netconfig
  id: connectivity_tests
- requires:
  - node_id: '4'
    name: pre_deployment_end
  type: stage
  id: deploy_start
  required_for: []
- requires:
  - node_id: '4'
    name: pre_deployment_start
  type: stage
  id: pre_deployment_end
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceph/ceph_compute.pp"
    timeout: 3600
    cwd: "/"
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceph/ceph_compute_post.rb
  type: puppet
  role:
  - compute
  required_for:
  - node_id: '4'
    name: post_deployment_end
  requires:
  - node_id: '4'
    name: ceph_create_pools
  id: ceph-compute
  condition: settings:storage.objects_ceph.value == true or settings:storage.images_ceph.value
    == true or settings:storage.volumes_ceph.value == true or settings:storage.ephemeral_ceph.value
    == true
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving.pp"
    timeout: 3600
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving_pre.rb
  groups:
  - primary-controller
  - controller
  - compute
  - compute-vmware
  - cinder
  - cinder-vmware
  - primary-mongo
  - mongo
  - ceph-osd
  - virt
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: firewall
  id: ssl-keys-saving
  condition: "(settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true) and settings:public_ssl.cert_source.value == 'user_uploaded'"
- role:
  - compute
  parameters:
    strategy:
      type: parallel
  required_for:
  - node_id: '4'
    name: deploy_end
  type: group
  requires:
  - node_id: '4'
    name: controller
  id: compute
- role:
  - primary-mongo
  - mongo
  - compute
  - ceph-osd
  - cinder
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/netconfig/configure_default_route.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '4'
    name: post_deployment_start
  id: configure_default_route
- requires:
  - node_id: '4'
    name: deploy_start
  type: stage
  id: deploy_end
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ceilometer/compute.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceilometer/compute_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ceilometer/compute_pre.rb
  groups:
  - compute
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: ceilometer-controller
  - node_id: '4'
    name: top-role-compute
  id: ceilometer-compute
  condition: settings:additional_components.ceilometer.value == true
- role: "*"
  parameters:
    timeout: 180
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: upload_file
  requires:
  - node_id: '4'
    name: override_configuration
  id: upload_configuration
- requires:
  - node_id: '4'
    name: post_deployment_start
  type: stage
  id: post_deployment_end
  required_for: []
- groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - virt
  - ironic
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/logging/logging.pp"
    timeout: 3600
  required_for:
  - node_id: '4'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '4'
    name: globals
  id: logging
- role: "*"
  parameters:
    retries: 10
    cmd: ntpdate -u $(awk '/^server/ { if ($2 !~ /127\.127\.[0-9]+\.[0-9]+/) {ORS="
      "; print $2}}' /etc/ntp.conf)
    timeout: 180
    interval: 30
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: shell
  requires:
  - node_id: '4'
    name: pre_deployment_start
  id: sync_time
- groups:
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/roles/compute.pp"
    timeout: 3600
  required_for:
  - node_id: '4'
    name: deploy_end
  type: puppet
  requires:
  - node_id: '4'
    name: hosts
  - node_id: '4'
    name: firewall
  refresh_on:
  - nova_config
  - nova_paste_api_ini
  id: top-role-compute
- groups:
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/compute-nova.pp"
    timeout: 1800
  required_for:
  - node_id: '4'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '4'
    name: openstack-network-common-config
  - node_id: '4'
    name: openstack-network-agents-l3
  - node_id: '4'
    name: openstack-network-agents-metadata
  id: openstack-network-compute-nova
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hosts/hosts.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: post_deployment_end
  type: puppet
  requires:
  - node_id: '4'
    name: upload_nodes_info
  id: update_hosts
- role:
  - primary-mongo
  - mongo
  - primary-controller
  - controller
  - compute
  - ceph-osd
  - cinder
  - cinder-vmware
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/dns/dns-client.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: ntp-client
  type: puppet
  requires:
  - node_id: '4'
    name: post_deployment_start
  id: dns-client
- groups:
  - primary-controller
  - controller
  - compute
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/openstack-network/agents/metadata.pp"
    timeout: 1800
  required_for:
  - node_id: '4'
    name: openstack-network-end
  type: puppet
  requires:
  - node_id: '4'
    name: openstack-network-common-config
  - node_id: '4'
    name: openstack-network-server-nova
  - node_id: '4'
    name: openstack-network-agents-l3
  refresh_on:
  - neutron_metadata_agent_config
  id: openstack-network-agents-metadata
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hosts/hosts.pp"
    timeout: 3600
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/hosts/hosts_post.rb
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/hosts/hosts_pre.rb
  groups:
  - primary-controller
  - controller
  - cinder
  - cinder-vmware
  - compute
  - ceph-osd
  - primary-mongo
  - mongo
  - ironic
  required_for:
  - node_id: '4'
    name: deploy_end
  requires:
  - node_id: '4'
    name: netconfig
  id: hosts
- role: "*"
  parameters:
    files:
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/haproxy/public_haproxy.pem"
      dst: "/var/lib/astute/haproxy/public_haproxy.pem"
    - src: "/var/lib/fuel/keys/{CLUSTER_ID}/haproxy/public_haproxy.crt"
      dst: "/etc/pki/tls/certs/public_haproxy.pem"
    dir_permissions: '0700'
    permissions: '0600'
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: copy_files
  requires:
  - node_id: '4'
    name: generate_haproxy_keys
  id: copy_haproxy_keys
  condition: "(settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true) and settings:public_ssl.cert_source.value == 'self_signed'"
- role: "*"
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/hiera/hiera.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: pre_deployment_end
  type: puppet
  requires:
  - node_id: '4'
    name: pre_deployment_start
  - node_id: '4'
    name: rsync_core_puppet
  id: pre_hiera_config
- role:
  - primary-mongo
  - mongo
  - compute
  - ceph-osd
  - cinder
  - cinder-vmware
  parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ntp/ntp-client.pp"
    timeout: 3600
    cwd: "/"
  required_for:
  - node_id: '4'
    name: post_deployment_end
  test_post:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ntp/ntp_post.rb
  type: puppet
  requires:
  - node_id: '4'
    name: dns-client
  id: ntp-client
- requires: []
  type: stage
  id: pre_deployment_start
  required_for: []
- parameters:
    puppet_modules: "/etc/puppet/modules"
    puppet_manifest: "/etc/puppet/modules/osnailyfacter/modular/ssl/ssl_add_trust_chain.pp"
    timeout: 3600
  type: puppet
  test_pre:
    cmd: ruby /etc/puppet/modules/osnailyfacter/modular/ssl/ssl_keys_saving_pre.rb
  groups:
  - primary-controller
  - controller
  - compute
  - compute-vmware
  - cinder
  - cinder-vmware
  - primary-mongo
  - mongo
  - ceph-osd
  - virt
  required_for:
  - node_id: '4'
    name: hosts
  requires:
  - node_id: '4'
    name: firewall
  - node_id: '4'
    name: ssl-keys-saving
  id: ssl-add-trust-chain
  condition: settings:public_ssl.horizon.value == true or settings:public_ssl.services.value
    == true
